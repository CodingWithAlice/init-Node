<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>重构 2 案例</title>
</head>

<body>
  <script>
    const plays = {
      "hamlet": {
        name: "Hamlet",
        type: "tragedy",
      },
      "as-like": {
        name: "As you like it",
        type: "comedy",
      },
      "othello": {
        name: "Othello",
        type: "tragedy",
      },
    };
    const invoice = [
      {
        customer: "BigCo",
        performance: [
          {
            playID: "hamlet",
            audience: 55
          },
          {
            playID: "as-like",
            audience: 35,
          },
          {
            playID: "othello",
            audience: 40
          }
        ]
      }
    ]
    function statement(invoice, plays) {
      let totalAmount = 0;
      let volumeCredits = 0;
      let result = `Statement for ${invoice.customer}\n`;
      const format = new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: "USD",
        minimumFractionDigits: 2
      }).format;
      for (let perf of invoice.performance) {

        // add volume credit
        volumeCredits += Math.max(perf.audience - 30, 0);
        // add extra credit for every ten comedy attendees
        if ("comedy" === playFor(perf).type) volumeCredits += Math.floor(perf.audience / 5);

        // print line for this order
        result += `${playFor(perf).name}:${format(this.amountFor(perf) / 100)}(${perf.audience} seats)\n`;
        totalAmount += this.amountFor(perf);
      }
      result += `Amount owed is ${format(totalAmount / 100)}\n`;
      result += `You earned ${volumeCredits} credits \n`;
      return result;
    }

    function playFor(aPerformance) {
      return plays[aPerformance.playID];
    }

    function amountFor(aPerformance) {
      let result = 0;
      switch (playFor(aPerformance).type) {
        case "tragedy":
          result = 40000;
          if (aPerformance.audience > 30) {
            result += 1000 * (aPerformance.audience - 30);
          }
          break;
        case "comedy":
          result = 30000;
          if (aPerformance.audience > 20) {
            result += 10000 + 500 * (aPerformance.audience - 20);
          }
          result += 300 * aPerformance.audience;
          break;
        default:
          throw new Error(`unknown type:${playFor(aPerformance).type}`);
      }
      return result;
    }
    // 执行函数
    const res = statement(invoice[0], plays);
    console.log(res);
    /**
     * 
     * Statement for BigCo
        Hamlet:$650.00(55 seats)
        As you like it:$580.00(35 seats)
        Othello:$500.00(40 seats)
        Amount owed is $1,730.00
        You earned 47 credits 
    */
  </script>
</body>

</html>